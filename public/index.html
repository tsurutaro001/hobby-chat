<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hobby Chat</title>
<style>
:root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
  margin:0; display:flex; flex-direction:column; min-height:100dvh; background:#fafafa;
}
header{
  display:flex; align-items:center; gap:8px; padding:10px 12px;
  border-bottom:1px solid #e5e5e5; background:#fff; position:sticky; top:0; z-index:10;
}
header h1{ font-size:16px; margin:0 }
.chip{ font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px }
.header-actions{ margin-left:auto; display:flex; gap:8px }
.header-actions button{
  font-size:12px; padding:4px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer;
}

#log{ flex:1; overflow:auto; padding:12px; }
.date-separator{
  text-align:center; margin:16px 0; font-size:13px; color:#666;
}

#bar{
  position:sticky; bottom:0;
  display:flex; gap:8px; padding:8px 8px calc(8px + var(--safe-bottom));
  border-top:1px solid #e5e5e5; background:#fff; z-index:10;
  box-shadow:0 -2px 8px rgba(0,0,0,.04);
}
input,button,select{ font-size:16px }
#nameSel{ width:30%; min-width:160px }
#text{ flex:1; min-width:0 }
#send{ padding:8px 12px }

.bubble{
  margin:6px 0; padding:8px 10px; border-radius:10px; background:#f1f3f5; max-width:90%;
  display:flex; align-items:baseline; gap:8px; flex-wrap:wrap;
}
.me{ background:#e8f0ff; margin-left:auto }
.msg-text{ white-space:pre-wrap; word-break:break-word }
.time{ font-size:11px; color:#666; margin-left:auto; opacity:.9; }
.sys{ color:#666; font-size:12px; margin:8px 0 }

@media (max-width:480px){ #nameSel{ width:45% } #send{ padding:8px } }
</style>

<header>
  <h1>Hobby Chat</h1><span class="chip">MVP</span>
  <div class="header-actions">
    <button id="notifBtn">ğŸ”• é€šçŸ¥OFF</button>
    <button id="clearBtn" title="ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤">ğŸ§¹ å±¥æ­´å‰Šé™¤</button>
  </div>
</header>

<div id="log"></div>

<div id="bar">
  <!-- å›ºå®šãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
  <select id="nameSel" title="ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ">
    <option value="">ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠï¼‰</option>
    <option value="ãªãŠã">ãªãŠã</option>
    <option value="ã‚Šã•">ã‚Šã•</option>
    <option value="ã•ãª">ã•ãª</option>
    <option value="ã‚Šã¨">ã‚Šã¨</option>
  </select>
  <input id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
  <button id="send">é€ä¿¡</button>
</div>

<script src="/socket.io/socket.io.js" crossorigin="anonymous"></script>
<script>
const socket = io();
const log    = document.getElementById('log');
const nameSel= document.getElementById('nameSel');
const textI  = document.getElementById('text');
const sendB  = document.getElementById('send');
const notifB = document.getElementById('notifBtn');
const clearB = document.getElementById('clearBtn');

// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæœ€æ–°ã¯â€œä¸‹â€é‹ç”¨ï¼‰ ---
function isNearBottom(elem, threshold = 40) {
  return elem.scrollTop + elem.clientHeight >= elem.scrollHeight - threshold;
}
function scrollToBottom(elem) { elem.scrollTop = elem.scrollHeight; }

// --- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¿å­˜ï¼†è‡ªå‹•join ---
nameSel.value = localStorage.getItem('nickname') || '';
if (nameSel.value) socket.emit('join', nameSel.value);
nameSel.addEventListener('change', () => {
  localStorage.setItem('nickname', nameSel.value);
  if (nameSel.value) socket.emit('join', nameSel.value);
});

function isMe(name) { return name === (nameSel.value || ''); }

// --- ç›¸å¯¾æ™‚åˆ» ---
function relativeTime(dateStr){
  const now = new Date();
  const d = new Date(dateStr);
  const diff = (now - d) / 1000;
  if (diff < 60) return "ãŸã£ãŸä»Š";
  if (diff < 3600) return Math.floor(diff/60) + "åˆ†å‰";
  if (diff < 86400) return Math.floor(diff/3600) + "æ™‚é–“å‰";
  if (diff < 172800) return "æ˜¨æ—¥";
  if (diff < 604800) return Math.floor(diff/86400) + "æ—¥å‰";
  return d.toLocaleDateString();
}

// --- æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ï¼ˆappendé‹ç”¨ï¼šæ–°ã—ã„æ—¥ã«ãªã£ãŸã‚‰åŒºåˆ‡ã‚Šã‚’â€œä¸‹â€ã«æŒ¿å…¥ï¼‰ ---
let lastDateKey = null;
function ensureSeparatorForAppend(dateStr){
  const d = new Date(dateStr);
  const dateKey = d.toISOString().split('T')[0];
  if (lastDateKey === dateKey) return;

  const labelDate = new Date(dateKey);
  const today = new Date();
  const diffDays = Math.floor((today - labelDate)/(1000*60*60*24));
  const label = diffDays===0 ? "ä»Šæ—¥" : diffDays===1 ? "æ˜¨æ—¥" : labelDate.toLocaleDateString();

  const sep = document.createElement('div');
  sep.className = 'date-separator';
  sep.textContent = label;
  log.append(sep);
  lastDateKey = dateKey;
}

// --- é€šçŸ¥ON/OFFï¼ˆã‚¢ãƒ—ãƒªå†…ãƒˆã‚°ãƒ« + ãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ï¼‰ ---
let notifEnabled = JSON.parse(localStorage.getItem('notifEnabled') ?? 'true'); // æ—¢å®šON
function updateNotifButton(){
  const perm = Notification?.permission;
  const label = (perm === 'granted' && notifEnabled) ? 'ğŸ”” é€šçŸ¥ON' : 'ğŸ”• é€šçŸ¥OFF';
  notifB.textContent = label;
}
notifB.onclick = async () => {
  if (!('Notification' in window)) return alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
  const perm = Notification.permission;
  if (perm !== 'granted') {
    const p = await Notification.requestPermission();
    if (p !== 'granted') { updateNotifButton(); return; }
    notifEnabled = true;
  } else {
    notifEnabled = !notifEnabled;
  }
  localStorage.setItem('notifEnabled', JSON.stringify(notifEnabled));
  updateNotifButton();
};
updateNotifButton();

function maybeNotify({name, text}){
  if (isMe(name)) return;
  if (!notifEnabled || Notification?.permission !== 'granted') return;
  const notInFront = document.hidden || !document.hasFocus();
  if (!notInFront) return;
  new Notification(`${name}`, { body: text, tag: 'hobby-chat' });
  if (navigator.vibrate) navigator.vibrate(30);
}

// --- é‡è¤‡é˜²æ­¢ï¼ˆidå„ªå…ˆã‚­ãƒ¼ï¼‰ ---
const seen = new Set();
const keyOf = (m) => m.id ? `id:${m.id}` : `${m.name}:${m.text}:${m.created_at || ''}`;

// --- æç”»ï¼ˆæœ€æ–°ã¯ä¸‹ï¼šappendï¼‰ ---
function addMsg(m, me=false){
  const k = keyOf(m);
  if (seen.has(k)) return;
  seen.add(k);

  // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’â€œå…ˆã«â€æŒ¿å…¥ï¼ˆãã®ä¸‹ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸¦ã¶ï¼‰
  ensureSeparatorForAppend(m.created_at);

  const wrap = document.createElement('div');
  wrap.className = 'bubble' + (me ? ' me' : '');
  const body = document.createElement('div');
  body.className = 'msg-text';
  body.textContent = `${m.name}: ${m.text}`;
  const time = document.createElement('span');
  time.className = 'time';
  time.textContent = relativeTime(m.created_at);
  wrap.append(body, time);
  log.append(wrap);
}

// --- ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ---
function addSys(t){
  const p = document.createElement('div');
  p.className = 'sys';
  p.textContent = t;
  log.append(p);
}

// --- å—ä¿¡ï¼šä¸‹ä»˜è¿‘ã«ã„ã‚‹æ™‚ã ã‘ã‚ªãƒ¼ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ---
socket.on('connect', () => { log.replaceChildren(); seen.clear(); lastDateKey = null; });
socket.on('sys', addSys);
socket.on('msg', (m) => {
  const auto = isNearBottom(log);
  const me = isMe(m.name);
  addMsg(m, me);
  if (auto) scrollToBottom(log);
  maybeNotify(m);
});

// --- é€ä¿¡ï¼ˆã‚µãƒ¼ãƒæˆ»ã‚Šã®ã¿æç”»ï¼é‡è¤‡é˜²æ­¢ï¼‰ ---
function joinIfNeeded(){ if (nameSel.value) socket.emit('join', nameSel.value); }
sendB.onclick = () => {
  if (!nameSel.value) return alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
  joinIfNeeded();
  const t = textI.value.trim();
  if(!t) return;
  const auto = isNearBottom(log);
  socket.emit('msg', t);
  textI.value = '';
  if (auto) scrollToBottom(log);
};
textI.addEventListener('keydown', e => { if(e.key==='Enter') sendB.click(); });
textI.addEventListener('focus', () => setTimeout(() => textI.scrollIntoView({block:'nearest'}), 50));

// --- å±¥æ­´å‰Šé™¤ï¼ˆç®¡ç†ãƒˆãƒ¼ã‚¯ãƒ³ã®å…¥åŠ›ã‚‚ã‚µãƒãƒ¼ãƒˆï¼‰ ---
clearB.onclick = () => {
  if (!nameSel.value) return alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
  if (!confirm('æœ¬å½“ã«å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) return;
  const token = prompt('ç®¡ç†ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆä»»æ„ã€‚è¨­å®šã—ã¦ã„ãªã„å ´åˆã¯ç©ºã§OKï¼‰');
  socket.emit('clear', { token: token || '' });
};
socket.on('cleared', () => {
  log.replaceChildren();
  seen.clear();
  lastDateKey = null;
  alert('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
});
</script>
</html>
