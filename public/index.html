<script src="/socket.io/socket.io.js" crossorigin="anonymous"></script>
<script>
const socket = io();
const log   = document.getElementById('log');
const nameI = document.getElementById('name');
const textI = document.getElementById('text');
const sendB = document.getElementById('send');
const notifB= document.getElementById('notifBtn');

// ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æ°¸ç¶šåŒ–
nameI.value = localStorage.getItem('nickname') || '';
nameI.addEventListener('input', () => localStorage.setItem('nickname', nameI.value.trim()));

// ç›¸å¯¾æ™‚é–“
function relativeTime(dateStr){
  const now = new Date();
  const d = new Date(dateStr);
  const diff = (now - d) / 1000;
  if (diff < 60) return "ãŸã£ãŸä»Š";
  if (diff < 3600) return Math.floor(diff/60) + "åˆ†å‰";
  if (diff < 86400) return Math.floor(diff/3600) + "æ™‚é–“å‰";
  if (diff < 172800) return "æ˜¨æ—¥";
  if (diff < 604800) return Math.floor(diff/86400) + "æ—¥å‰";
  return d.toLocaleDateString();
}

// ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ç®¡ç†ï¼ˆæœ€æ–°ãŒä¸Šï¼prependé‹ç”¨ã«æœ€é©åŒ–ï¼‰
let topDateKey = null; // ç›´è¿‘ã§ã€Œå…ˆé ­ã«ã‚ã‚‹æ—¥ã®ã‚­ãƒ¼ã€
function ensureSeparatorFor(dateStr){
  const d = new Date(dateStr);
  const dateKey = d.toISOString().split('T')[0];
  if (topDateKey === dateKey) return;

  const labelDate = new Date(dateKey);
  const today = new Date();
  const diffDays = Math.floor((today - labelDate)/(1000*60*60*24));
  const label = diffDays===0 ? "ä»Šæ—¥" : diffDays===1 ? "æ˜¨æ—¥" : labelDate.toLocaleDateString();

  const sep = document.createElement('div');
  sep.className = 'date-separator';
  sep.textContent = label;
  // ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®â€œã•ã‚‰ã«ä¸Šâ€ã«æ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€æœ€å¾Œã«prependã™ã‚‹
  log.prepend(sep);
  topDateKey = dateKey;
}

// é€šçŸ¥
function updateNotifButton(){
  notifB && (notifB.textContent = (Notification?.permission === 'granted') ? 'ðŸ”” é€šçŸ¥ON' : 'ðŸ”• é€šçŸ¥OFF');
}
notifB && (notifB.onclick = async () => {
  if (!('Notification' in window)) return alert('é€šçŸ¥ã«éžå¯¾å¿œã§ã™');
  if (Notification.permission !== 'granted') await Notification.requestPermission();
  updateNotifButton();
});
updateNotifButton();

// æç”» & é‡è¤‡å¯¾ç­–
const seen = new Set();
const keyOf = (m) => m.id ? `id:${m.id}` : `${m.name}:${m.text}:${m.created_at || ''}`;

function addMsg(m, me=false){
  const k = keyOf(m);
  if (seen.has(k)) return;
  seen.add(k);

  // 1) å…ˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’prepend
  const wrap = document.createElement('div');
  wrap.className = 'bubble' + (me ? ' me' : '');
  const body = document.createElement('div');
  body.className = 'msg-text';
  body.textContent = `${m.name}: ${m.text}`;
  const time = document.createElement('span');
  time.className = 'time';
  time.textContent = relativeTime(m.created_at);
  wrap.append(body, time);
  log.prepend(wrap);

  // 2) ãã®â€œã•ã‚‰ã«ä¸Šâ€ã«æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’å¿…è¦ã«å¿œã˜ã¦é…ç½®
  ensureSeparatorFor(m.created_at);
}

function addSys(t){
  const p = document.createElement('div');
  p.className = 'sys';
  p.textContent = t;
  log.prepend(p);
}

// é€šçŸ¥
function maybeNotify(m){
  const me = m.name === nameI.value.trim();
  if (me) return;
  if (document.hidden && Notification?.permission === 'granted') {
    new Notification(`${m.name}`, { body: m.text, tag: 'hobby-chat' });
    if (navigator.vibrate) navigator.vibrate(30);
  }
}

// ã‚½ã‚±ãƒƒãƒˆ
socket.on('connect', () => { log.replaceChildren(); seen.clear(); topDateKey = null; });
socket.on('sys', addSys);
socket.on('msg', (m) => {
  const me = (m.name === nameI.value.trim());
  addMsg(m, me);
  maybeNotify(m);
});

// é€ä¿¡ï¼ˆâ€» æ¥½è¦³æç”»ã›ãšã€ã‚µãƒ¼ãƒã‹ã‚‰æˆ»ã£ãŸ1ä»¶ã®ã¿è¡¨ç¤ºï¼‰
function joinIfNeeded(){ const n = nameI.value.trim(); if(n) socket.emit('join', n); }
sendB.onclick = () => {
  joinIfNeeded();
  const t = textI.value.trim();
  if(!t) return;
  socket.emit('msg', t);
  textI.value = '';
};
textI.addEventListener('keydown', e => { if(e.key==='Enter') sendB.click(); });

// ãƒ¢ãƒã‚¤ãƒ«å¯¾ç­–
textI.addEventListener('focus', () => setTimeout(() => textI.scrollIntoView({block:'nearest'}), 50));
</script>
