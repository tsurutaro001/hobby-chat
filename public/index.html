<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Hobby Chat</title>
<style>
:root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
  margin:0; display:flex; flex-direction:column; min-height:100dvh; background:#fafafa;
  overscroll-behavior-y: contain;
}
header{
  display:flex; align-items:center; gap:8px; padding:10px 12px;
  border-bottom:1px solid #e5e5e5; background:#fff; position:sticky; top:0; z-index:10;
}
header h1{ font-size:16px; margin:0; cursor:pointer; user-select:none; }
.chip{ font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px }
.header-actions{ margin-left:auto; display:flex; gap:8px }
.header-actions button{
  font-size:12px; padding:4px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer;
}

#log{ flex:1; overflow:auto; padding:12px; -webkit-overflow-scrolling: touch; }
.date-separator{
  text-align:center; margin:16px 0; font-size:13px; color:#666;
}

/* ==== 2æ®µã‚³ãƒ³ã‚½ãƒ¼ãƒ« ==== */
#bar{
  position:sticky; bottom:0;
  display:grid;
  grid-template-columns: minmax(140px, 240px) auto auto; /* 1è¡Œç›® */
  grid-template-rows: auto auto; /* 2è¡Œæ§‹æˆ */
  gap:8px; padding:8px 8px calc(8px + var(--safe-bottom));
  border-top:1px solid #e5e5e5; background:#fff; z-index:10;
  box-shadow:0 -2px 8px rgba(0,0,0,.04);
  align-items:center;
}
select, button, textarea{ font-size:16px }

/* 1è¡Œç›® */
#nameSel{ grid-column: 1 / 2; width:100% }
#photoBtn{ grid-column: 2 / 3; padding:8px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; }
#send{ grid-column: 3 / 4; padding:8px 12px }

/* 2è¡Œç›®ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¯æ¨ªå¹…ã„ã£ã±ã„ï¼‰ */
#text{
  grid-column: 1 / 4; width:100%;
  min-height:3.2em; max-height:11em; resize: none;
  line-height:1.5; padding:10px 12px;
  border:1px solid #ddd; border-radius:8px;
}
#photo{ display:none } /* éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› */

.bubble{
  margin:6px 0; padding:8px 10px; border-radius:10px; background:#f1f3f5; max-width:92%;
  display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap;
}
.me{ background:#e8f0ff; margin-left:auto }
.msg-text{ white-space:pre-wrap; word-break:break-word }
.time{ font-size:11px; color:#666; margin-left:auto; opacity:.9; }
.sys{ color:#666; font-size:12px; margin:8px 0 }

.read-badge{
  font-size:11px; color:#4a5568; background:#e2e8f0; border-radius:999px; padding:2px 8px; margin-left:6px;
}

mark { background: #ffe56a; padding: 0 2px; border-radius: 2px; }

/* ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œ */
.mention-box{
  position:absolute; left: 8px; right: 8px;
  bottom: calc(78px + var(--safe-bottom)); /* å…¥åŠ›åŸŸãŒé«˜ããªã£ãŸã®ã§ä¸Šã’ã‚‹ */
  display:none; background:#fff; border:1px solid #e5e5e5; border-radius:8px;
  box-shadow:0 8px 24px rgba(0,0,0,.08); padding:6px; z-index: 20;
}
.mention-list{ display:flex; flex-wrap:wrap; gap:6px; }
.mention-item{
  padding:6px 10px; border:1px solid #ddd; border-radius:999px; cursor:pointer; background:#fafafa;
}
.mention-item.active{ outline: 2px solid #7aa7ff; background:#eef3ff; }

img.chat-photo{
  max-width: min(60vw, 420px);
  height: auto;
  border-radius: 10px;
  display:block;
}

@media (max-width:480px){
  #bar{ grid-template-columns: minmax(120px, 1fr) auto auto; }
}
</style>

<header>
  <h1 id="title">Hobby Chat</h1><span class="chip">MVP</span>
  <div class="header-actions">
    <button id="notifBtn" aria-live="polite">ğŸ”• é€šçŸ¥OFF</button>
    <button id="clearBtn" title="ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤">ğŸ§¹ å±¥æ­´å‰Šé™¤</button>
  </div>
</header>

<div id="log"></div>

<div id="bar">
  <!-- 1è¡Œç›® -->
  <select id="nameSel" title="ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ">
    <option value="">ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠï¼‰</option>
    <option value="ãªãŠã">ãªãŠã</option>
    <option value="ã‚Šã•">ã‚Šã•</option>
    <option value="ã•ãª">ã•ãª</option>
    <option value="ã‚Šã¨">ã‚Šã¨</option>
  </select>
  <button id="photoBtn" title="å†™çœŸã‚’é€ã‚‹">ğŸ“·</button>
  <input id="photo" type="file" accept="image/*">
  <button id="send">é€ä¿¡</button>

  <!-- 2è¡Œç›® -->
  <textarea id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆEnterã§é€ä¿¡ãƒ»Shift+Enterã§æ”¹è¡Œï¼‰" rows="2"></textarea>
</div>

<!-- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œ -->
<div id="mentionBox" class="mention-box"><div class="mention-list" id="mentionList"></div></div>

<script src="/socket.io/socket.io.js" crossorigin="anonymous"></script>
<script>
/* ===== å®šæ•°ãƒ»å‚ç…§ ===== */
const MEMBERS = ['ãªãŠã', 'ã‚Šã•', 'ã•ãª', 'ã‚Šã¨'];
const MAX_BYTES = 700 * 1024; // 700KB ä¸Šé™
const socket  = io();
const log     = document.getElementById('log');
const nameSel = document.getElementById('nameSel');
const textI   = document.getElementById('text');   // textarea
const photoI  = document.getElementById('photo');
const photoB  = document.getElementById('photoBtn');
const sendB   = document.getElementById('send');
const notifB  = document.getElementById('notifBtn');
const clearB  = document.getElementById('clearBtn');
const titleEl = document.getElementById('title');
const mentionBox  = document.getElementById('mentionBox');
const mentionList = document.getElementById('mentionList');

/* ===== ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼šã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œ ===== */
if (window.visualViewport) {
  const onVV = () => {
    const vh = window.visualViewport.height;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  };
  window.visualViewport.addEventListener('resize', onVV);
  onVV();
}

/* ===== ä¾¿åˆ©é–¢æ•° ===== */
function isNearBottom(elem, th = 40) { return elem.scrollTop + elem.clientHeight >= elem.scrollHeight - th; }
function scrollToBottom(elem) { elem.scrollTop = elem.scrollHeight; }
function isMe(name) { return name === (nameSel.value || ''); }
function escapeHTML(s){
  return String(s)
   .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
   .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function byteLengthFromDataURL(dataURL){
  const b64 = dataURL.split(',')[1] || '';
  // base64 ã®å®ŸåŠ¹ãƒã‚¤ãƒˆæ•°ï¼ˆæ¦‚ç®—ï¼‰
  return Math.floor((b64.length * 3) / 4);
}

/* ===== ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ãƒƒãƒ—ã§ãƒªãƒ­ãƒ¼ãƒ‰ ===== */
titleEl.addEventListener('click', () => location.reload());

/* ===== ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¿å­˜ï¼†è‡ªå‹•join ===== */
nameSel.value = localStorage.getItem('nickname') || '';
if (nameSel.value) socket.emit('join', nameSel.value);
nameSel.addEventListener('change', () => {
  localStorage.setItem('nickname', nameSel.value);
  if (nameSel.value) socket.emit('join', nameSel.value);
});

/* ===== å…¥åŠ›æ¬„ã‚ªãƒ¼ãƒˆãƒªã‚µã‚¤ã‚º ===== */
function autoResize() {
  textI.style.height = 'auto';
  const h = Math.min(textI.scrollHeight, 11 * 20 + 16);
  textI.style.height = h + 'px';
}
textI.addEventListener('input', autoResize);
textI.addEventListener('focus', () => setTimeout(() => {
  autoResize(); textI.scrollIntoView({block:'nearest'});
}, 30));
autoResize();

/* ===== ç›¸å¯¾æ™‚åˆ» ===== */
function relativeTime(dateStr){
  const now = new Date();
  const d = new Date(dateStr);
  const diff = (now - d) / 1000;
  if (diff < 60) return "ãŸã£ãŸä»Š";
  if (diff < 3600) return Math.floor(diff/60) + "åˆ†å‰";
  if (diff < 86400) return Math.floor(diff/3600) + "æ™‚é–“å‰";
  if (diff < 172800) return "æ˜¨æ—¥";
  if (diff < 604800) return Math.floor(diff/86400) + "æ—¥å‰";
  return d.toLocaleDateString();
}

/* ===== æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ï¼ˆappendé‹ç”¨ï¼‰ ===== */
let lastDateKey = null;
function ensureSeparatorForAppend(dateStr){
  const d = new Date(dateStr);
  const dateKey = d.toISOString().split('T')[0];
  if (lastDateKey === dateKey) return;
  const labelDate = new Date(dateKey);
  const today = new Date();
  const diffDays = Math.floor((today - labelDate)/(1000*60*60*24));
  const label = diffDays===0 ? "ä»Šæ—¥" : diffDays===1 ? "æ˜¨æ—¥" : labelDate.toLocaleDateString();
  const sep = document.createElement('div');
  sep.className = 'date-separator';
  sep.textContent = label;
  log.append(sep);
  lastDateKey = dateKey;
}

/* ===== é€šçŸ¥ï¼ˆæœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã¯ç„¡åŠ¹åŒ–ï¼‰ ===== */
let notifEnabled = true; try { const saved = localStorage.getItem('notifEnabled'); if (saved!=null) notifEnabled = JSON.parse(saved); } catch {}
function supportsNotification(){
  return (typeof Notification !== 'undefined') && typeof Notification.requestPermission === 'function';
}
function updateNotifButton(){
  if (!supportsNotification()) {
    notifB.textContent = 'ğŸš« é€šçŸ¥éå¯¾å¿œ';
    notifB.disabled = true;
    notifB.title = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é€šçŸ¥APIãŒä½¿ãˆã¾ã›ã‚“ï¼ˆiOSã¯PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§æœ‰åŠ¹ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰';
    return;
  }
  const perm = Notification.permission;
  const label = (perm === 'granted' && notifEnabled) ? 'ğŸ”” é€šçŸ¥ON' : 'ğŸ”• é€šçŸ¥OFF';
  notifB.textContent = label;
}
notifB.onclick = async () => {
  if (!supportsNotification()) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é€šçŸ¥ãŒä½¿ãˆã¾ã›ã‚“'); return; }
  const perm = Notification.permission;
  if (perm !== 'granted') {
    const p = await Notification.requestPermission();
    if (p !== 'granted') { updateNotifButton(); return; }
    notifEnabled = true;
  } else {
    notifEnabled = !notifEnabled;
  }
  localStorage.setItem('notifEnabled', JSON.stringify(notifEnabled));
  updateNotifButton();
};
updateNotifButton();

function maybeNotify({name, text}){
  if (isMe(name)) return;
  if (!supportsNotification() || !notifEnabled || Notification.permission !== 'granted') return;
  const my = nameSel.value;
  const mentioned = text && text.includes(`@${my}`);
  const notInFront = document.hidden || !document.hasFocus();
  if (!mentioned && !notInFront) return;
  const title = mentioned ? `ğŸ“£ ã‚ãªãŸå®›ã¦ (${name})` : `${name}`;
  new Notification(title, { body: text || 'å†™çœŸãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ', tag: 'hobby-chat' });
  if (navigator.vibrate) navigator.vibrate(mentioned ? 100 : 30);
}

/* ===== æ—¢èª­ï¼ˆè‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã ã‘ãƒãƒƒã‚¸è¡¨ç¤ºï¼‰ ===== */
const lastReads = new Map(); // name -> last_message_id
function updateReadBadgeFor(messageId, bubbleEl, sender){
  if (sender !== nameSel.value) {
    const exist = bubbleEl.querySelector('.read-badge');
    if (exist) exist.remove();
    return;
  }
  let count = 0;
  for (const m of MEMBERS) {
    if (m === sender) continue;
    const v = lastReads.get(m) || 0;
    if (v >= messageId) count++;
  }
  let badge = bubbleEl.querySelector('.read-badge');
  if (!badge) {
    badge = document.createElement('span');
    badge.className = 'read-badge';
    bubbleEl.appendChild(badge);
  }
  badge.textContent = count >= (MEMBERS.length - 1) ? 'æ—¢èª­ å…¨å“¡' : `æ—¢èª­ ${count}`;
}

/* ===== é‡è¤‡é˜²æ­¢ ===== */
const seen = new Set();
const keyOf = (m) => m.id ? `id:${m.id}` : `${m.name}:${m.text}:${m.created_at || ''}`;

/* ===== ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¼·èª¿ ===== */
function renderTextWithMentions(raw){
  let esc = escapeHTML(raw);
  esc = esc.replace(/@(?:ãªãŠã|ã‚Šã•|ã•ãª|ã‚Šã¨)/g, (mt) => `<mark>${mt}</mark>`);
  return esc;
}

/* ===== æç”»ï¼ˆæœ€æ–°ã¯ä¸‹ï¼šappendï¼‰ ===== */
function addMsg(m, me=false){
  const k = keyOf(m);
  if (seen.has(k)) return;
  seen.add(k);

  ensureSeparatorForAppend(m.created_at);

  const wrap = document.createElement('div');
  wrap.className = 'bubble' + (me ? ' me' : '');
  wrap.dataset.id = m.id;
  wrap.dataset.sender = m.name;

  const body = document.createElement('div');
  body.className = 'msg-text';

  if (m.image_base64) {
    const img = document.createElement('img');
    img.className = 'chat-photo';
    img.alt = 'photo';
    img.src = m.image_base64;
    body.innerHTML = `${escapeHTML(m.name)}:`;
    body.appendChild(document.createElement('br'));
    body.appendChild(img);
  } else {
    body.innerHTML = `${escapeHTML(m.name)}: ${renderTextWithMentions(m.text)}`;
  }

  const time = document.createElement('span');
  time.className = 'time';
  time.textContent = relativeTime(m.created_at);

  wrap.append(body, time);
  log.append(wrap);

  // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã ã‘æ—¢èª­ãƒãƒƒã‚¸ï¼ˆåˆæœŸæç”»ï¼‰
  updateReadBadgeFor(m.id, wrap, m.name);
}

/* ===== ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
function addSys(t){
  const p = document.createElement('div');
  p.className = 'sys';
  p.textContent = t;
  log.append(p);
}

/* ===== ã‚½ã‚±ãƒƒãƒˆå—ä¿¡ ===== */
socket.on('connect', () => { log.replaceChildren(); seen.clear(); lastDateKey = null; });
socket.on('sys', addSys);

socket.on('reads_bulk', (rows) => {
  rows.forEach(r => lastReads.set(r.name, r.last_message_id || 0));
  // åˆæœŸæç”»å¾Œã«å…¨å¹ãå‡ºã—ã‚’æ›´æ–°
  document.querySelectorAll('.bubble').forEach(el => {
    const id = Number(el.dataset.id);
    const sender = el.dataset.sender;
    if (id) updateReadBadgeFor(id, el, sender);
  });
});
socket.on('reads', ({name, last_message_id}) => {
  lastReads.set(name, last_message_id || 0);
  // å…¨ä½“æ›´æ–°ï¼ˆç°¡æ˜“ï¼‰
  document.querySelectorAll('.bubble').forEach(el => {
    const id = Number(el.dataset.id);
    const sender = el.dataset.sender;
    if (id) updateReadBadgeFor(id, el, sender);
  });
});

socket.on('msg', (m) => {
  const auto = isNearBottom(log);
  const me = isMe(m.name);
  addMsg(m, me);
  if (auto) scrollToBottom(log);
  maybeNotify(m);
  // è¡¨ç¤ºã—ãŸã‚‰æ—¢èª­ã‚’é€²ã‚ã‚‹ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰
  const lastId = Number(m.id) || 0;
  if (isNearBottom(log) && nameSel.value) socket.emit('read_upto', lastId);
});

/* ===== é€ä¿¡ï¼ˆEnteré€ä¿¡ / Shift+Enteræ”¹è¡Œï¼‰ ===== */
function joinIfNeeded(){ if (nameSel.value) socket.emit('join', nameSel.value); }
sendB.onclick = () => {
  if (!nameSel.value) return alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
  joinIfNeeded();
  const t = textI.value.trim();
  if(!t) return;
  const auto = isNearBottom(log);
  socket.emit('msg', t);
  textI.value = '';
  autoResize();
  if (auto) scrollToBottom(log);
};
textI.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å€™è£œãŒå‡ºã¦ã„ã‚Œã°è£œå®Œã€ç„¡ã‘ã‚Œã°é€ä¿¡
    if (mentionBox.style.display === 'block') {
      applyActiveMention();
    } else {
      sendB.click();
    }
  } else if (e.key === 'Tab' && mentionBox.style.display === 'block') {
    e.preventDefault(); applyActiveMention();
  } else if (e.key === 'ArrowDown' && mentionBox.style.display === 'block') {
    e.preventDefault(); moveActiveMention(1);
  } else if (e.key === 'ArrowUp' && mentionBox.style.display === 'block') {
    e.preventDefault(); moveActiveMention(-1);
  }
});

/* ===== ç”»åƒé€ä¿¡ï¼ˆ>700KBãªã‚‰è‡ªå‹•åœ§ç¸®ï¼‰ ===== */
photoB.onclick = () => photoI.click();
photoI.onchange = async () => {
  const f = photoI.files?.[0];
  if (!f) return;
  try {
    const dataURL = await toDataURLWithCompressIfNeeded(f, MAX_BYTES);
    socket.emit('upload_image', { dataURL });
  } catch (e) {
    alert(e?.message || 'ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
  } finally {
    photoI.value = '';
  }
};

/* åœ§ç¸®ãƒ˜ãƒ«ãƒ‘ï¼šJPEG/WebPã§å“è³ªâ†’ãƒªã‚µã‚¤ã‚ºã®é †ã«ä¸‹ã’ã¦MAX_BYTESä»¥ä¸‹ã«åã‚ã‚‹ */
async function toDataURLWithCompressIfNeeded(file, maxBytes){
  // ã¾ãšãã®ã¾ã¾ DataURL ã‚’ä½œã‚‹
  const direct = await fileToDataURL(file);
  if (byteLengthFromDataURL(direct) <= maxBytes) return direct;

  // ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ Canvas ã¸
  const {img, w, h} = await loadImageFromFile(file);

  // PNGç­‰ã§ã‚‚è»½é‡åŒ–ã®ãŸã‚ JPEG ã‚’å„ªå…ˆ
  const preferred = 'image/jpeg';
  // å“è³ªã‚’æ®µéšçš„ã«ä¸‹ã’ã‚‹ï¼ˆã¾ãšã¯å¯¸æ³•ã¯ãã®ã¾ã¾ï¼‰
  for (let q = 0.92; q >= 0.5; q -= 0.08) {
    const url = drawToDataURL(img, w, h, preferred, q);
    if (byteLengthFromDataURL(url) <= maxBytes) return url;
  }
  // ã¾ã å¤§ãã‘ã‚Œã°å¯¸æ³•ã‚’å°‘ã—ãšã¤ç¸®å°ï¼ˆæœ€å°è¾º 512px ã¾ã§ï¼‰ï¼‹å“è³ªã‚‚èª¿æ•´
  let cw = w, ch = h;
  while (Math.min(cw, ch) > 512) {
    cw = Math.round(cw * 0.85);
    ch = Math.round(ch * 0.85);
    for (let q = 0.9; q >= 0.5; q -= 0.1) {
      const url = drawToDataURL(img, cw, ch, preferred, q);
      if (byteLengthFromDataURL(url) <= maxBytes) return url;
    }
  }
  // æœ€çµ‚æ‰‹æ®µï¼šæœ€å°ã‚µã‚¤ã‚ºï¼†æœ€ä½å“è³ª
  return drawToDataURL(img, Math.max(512, Math.round(w*0.5)), Math.max(512, Math.round(h*0.5)), preferred, 0.5);
}

function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
    r.readAsDataURL(file);
  });
}

function loadImageFromFile(file){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      URL.revokeObjectURL(url);
      resolve({img, w: img.naturalWidth, h: img.naturalHeight});
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      reject(new Error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
    };
    img.src = url;
  });
}

function drawToDataURL(img, w, h, mime, quality){
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  // ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’å¼·ã‚ã«
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(img, 0, 0, w, h);
  let url;
  try { url = c.toDataURL(mime, quality); }
  catch { url = c.toDataURL(); } // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  return url;
}

/* ===== æ—¢èª­ï¼šæœ€ä¸‹éƒ¨ã«ã„ã‚‹æ™‚ã«æ›´æ–° ===== */
const throttle = (fn, ms=400) => { let t=0; return (...a)=>{const n=Date.now(); if(n-t>ms){t=n; fn(...a);} }; };
const trySendRead = throttle(() => {
  if (!nameSel.value) return;
  if (!isNearBottom(log)) return;
  const last = [...document.querySelectorAll('.bubble')].pop();
  if (!last) return;
  const id = Number(last.dataset.id);
  if (id) socket.emit('read_upto', id);
}, 500);

log.addEventListener('scroll', trySendRead);
document.addEventListener('visibilitychange', () => { if (!document.hidden) trySendRead(); });

/* ===== å±¥æ­´å‰Šé™¤ ===== */
clearB.onclick = () => {
  if (!nameSel.value) return alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
  if (!confirm('æœ¬å½“ã«å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰')) return;
  const token = prompt('ç®¡ç†ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆä»»æ„ã€‚è¨­å®šã—ã¦ã„ãªã„å ´åˆã¯ç©ºã§OKï¼‰');
  socket.emit('clear', { token: token || '' });
};
socket.on('cleared', () => {
  log.replaceChildren(); seen.clear(); lastDateKey = null;
  alert('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
});

/* ===== ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³è£œå®Œ ===== */
let activeIdx = -1;
function findMentionToken(){
  const pos = textI.selectionStart;
  const val = textI.value;
  const left = val.slice(0, pos);
  const m = left.match(/(^|\s)@([^\s@]{0,20})$/);
  if(!m) return null;
  const prefix = m[2];
  const start = pos - prefix.length;
  const atPos = start - 1;
  return { atPos, start, end: pos, prefix };
}
function showMentionBox(items){
  mentionList.innerHTML = '';
  items.forEach((name, i) => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'mention-item' + (i===0 ? ' active':'');
    b.textContent = '@' + name;
    b.onclick = () => applyMention(name);
    mentionList.appendChild(b);
  });
  activeIdx = items.length ? 0 : -1;
  mentionBox.style.display = items.length ? 'block' : 'none';
}
function hideMentionBox(){ mentionBox.style.display = 'none'; activeIdx = -1; }
function applyMention(name){
  const tok = findMentionToken(); if(!tok) return hideMentionBox();
  const val = textI.value;
  const before = val.slice(0, tok.atPos);
  const after  = val.slice(tok.end);
  textI.value = before + '@' + name + ' ' + after;
  const newPos = (before + '@' + name + ' ').length;
  textI.setSelectionRange(newPos, newPos);
  hideMentionBox(); textI.focus(); autoResize();
}
function moveActiveMention(step){
  const buttons = [...mentionList.querySelectorAll('.mention-item')];
  if (!buttons.length) return;
  activeIdx = (activeIdx + step + buttons.length) % buttons.length;
  buttons.forEach((b, i) => b.classList.toggle('active', i===activeIdx));
}
function applyActiveMention(){
  const btn = mentionList.querySelector('.mention-item.active');
  if (btn) applyMention(btn.textContent.replace(/^@/, ''));
}
textI.addEventListener('input', () => {
  const tok = findMentionToken();
  if(!tok){ hideMentionBox(); return; }
  const cand = MEMBERS.filter(n => n.startsWith(tok.prefix || ''));
  showMentionBox(cand);
});
document.addEventListener('click', (e) => {
  if (e.target === textI || e.target === mentionBox || mentionBox.contains(e.target)) return;
  hideMentionBox();
});
</script>
</html>