<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hobby Chat</title>
<style>
:root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
  margin:0; display:flex; flex-direction:column; min-height:100dvh; background:#fafafa;
}
header{
  display:flex; align-items:center; gap:8px; padding:10px 12px;
  border-bottom:1px solid #e5e5e5; background:#fff; position:sticky; top:0; z-index:10;
}
header h1{ font-size:16px; margin:0; cursor:pointer; user-select:none; }
.chip{ font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px }
.header-actions{ margin-left:auto; display:flex; gap:8px }
.header-actions button{
  font-size:12px; padding:4px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer;
}

#log{ flex:1; overflow:auto; padding:12px; }
.date-separator{
  text-align:center; margin:16px 0; font-size:13px; color:#666;
}

#bar{
  position:sticky; bottom:0;
  display:flex; gap:8px; padding:8px 8px calc(8px + var(--safe-bottom));
  border-top:1px solid #e5e5e5; background:#fff; z-index:10;
  box-shadow:0 -2px 8px rgba(0,0,0,.04);
  align-items: center;
}
input,button,select{ font-size:16px }
#nameSel{ width:30%; min-width:160px }
#text{ flex:1; min-width:0 }
#send{ padding:8px 12px }

.bubble{
  margin:6px 0; padding:8px 10px; border-radius:10px; background:#f1f3f5; max-width:90%;
  display:flex; align-items:baseline; gap:8px; flex-wrap:wrap;
}
.me{ background:#e8f0ff; margin-left:auto }
.msg-text{ white-space:pre-wrap; word-break:break-word }
.time{ font-size:11px; color:#666; margin-left:auto; opacity:.9; }
.sys{ color:#666; font-size:12px; margin:8px 0 }

mark {
  background: #ffe56a;
  padding: 0 2px;
  border-radius: 2px;
}

/* メンション候補ポップアップ */
.mention-box{
  position:absolute;
  bottom: calc(52px + var(--safe-bottom)); /* 入力欄の少し上に重ねる */
  left: 8px;
  right: 8px;
  display:none;
  background:#fff;
  border:1px solid #e5e5e5;
  border-radius:8px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  padding:6px;
  z-index: 20;
}
.mention-list{ display:flex; flex-wrap:wrap; gap:6px; }
.mention-item{
  padding:6px 10px; border:1px solid #ddd; border-radius:999px; cursor:pointer; background:#fafafa;
}
.mention-item.active{
  outline: 2px solid #7aa7ff;
  background:#eef3ff;
}

@media (max-width:480px){ #nameSel{ width:45% } #send{ padding:8px } }
</style>

<header>
  <h1 id="title">Hobby Chat</h1><span class="chip">MVP</span>
  <div class="header-actions">
    <button id="notifBtn">🔕 通知OFF</button>
    <button id="clearBtn" title="チャット履歴をすべて削除">🧹 履歴削除</button>
  </div>
</header>

<div id="log"></div>

<div id="bar">
  <!-- 固定メンバーのプルダウン -->
  <select id="nameSel" title="メンバーを選択">
    <option value="">（メンバーを選択）</option>
    <option value="なおき">なおき</option>
    <option value="りさ">りさ</option>
    <option value="さな">さな</option>
    <option value="りと">りと</option>
  </select>
  <input id="text" placeholder="メッセージを入力">
  <button id="send">送信</button>
</div>

<!-- メンション候補ポップアップ -->
<div id="mentionBox" class="mention-box">
  <div class="mention-list" id="mentionList"></div>
</div>

<script src="/socket.io/socket.io.js" crossorigin="anonymous"></script>
<script>
/* ===== 定数・参照 ===== */
const MEMBERS = ['なおき', 'りさ', 'さな', 'りと'];

const socket  = io();
const log     = document.getElementById('log');
const nameSel = document.getElementById('nameSel');
const textI   = document.getElementById('text');
const sendB   = document.getElementById('send');
const notifB  = document.getElementById('notifBtn');
const clearB  = document.getElementById('clearBtn');
const titleEl = document.getElementById('title');

const mentionBox  = document.getElementById('mentionBox');
const mentionList = document.getElementById('mentionList');

/* ===== ユーティリティ ===== */
function isNearBottom(elem, threshold = 40) {
  return elem.scrollTop + elem.clientHeight >= elem.scrollHeight - threshold;
}
function scrollToBottom(elem) { elem.scrollTop = elem.scrollHeight; }
function isMe(name) { return name === (nameSel.value || ''); }
function escapeHTML(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ===== タイトルクリックでリロード ===== */
titleEl.addEventListener('click', () => location.reload());

/* ===== ニックネーム保存＆自動join ===== */
nameSel.value = localStorage.getItem('nickname') || '';
if (nameSel.value) socket.emit('join', nameSel.value);
nameSel.addEventListener('change', () => {
  localStorage.setItem('nickname', nameSel.value);
  if (nameSel.value) socket.emit('join', nameSel.value);
});

/* ===== 相対時刻 ===== */
function relativeTime(dateStr){
  const now = new Date();
  const d = new Date(dateStr);
  const diff = (now - d) / 1000;
  if (diff < 60) return "たった今";
  if (diff < 3600) return Math.floor(diff/60) + "分前";
  if (diff < 86400) return Math.floor(diff/3600) + "時間前";
  if (diff < 172800) return "昨日";
  if (diff < 604800) return Math.floor(diff/86400) + "日前";
  return d.toLocaleDateString();
}

/* ===== 日付セパレータ（append運用） ===== */
let lastDateKey = null;
function ensureSeparatorForAppend(dateStr){
  const d = new Date(dateStr);
  const dateKey = d.toISOString().split('T')[0];
  if (lastDateKey === dateKey) return;

  const labelDate = new Date(dateKey);
  const today = new Date();
  const diffDays = Math.floor((today - labelDate)/(1000*60*60*24));
  const label = diffDays===0 ? "今日" : diffDays===1 ? "昨日" : labelDate.toLocaleDateString();

  const sep = document.createElement('div');
  sep.className = 'date-separator';
  sep.textContent = label;
  log.append(sep);
  lastDateKey = dateKey;
}

/* ===== 通知ON/OFF（アプリ内トグル + 権限） ===== */
let notifEnabled = JSON.parse(localStorage.getItem('notifEnabled') ?? 'true'); // 既定ON
function updateNotifButton(){
  const perm = (typeof Notification !== 'undefined') ? Notification.permission : 'denied';
  const label = (perm === 'granted' && notifEnabled) ? '🔔 通知ON' : '🔕 通知OFF';
  notifB.textContent = label;
}
notifB.onclick = async () => {
  if (typeof Notification === 'undefined') return alert('このブラウザは通知に対応していません');
  const perm = Notification.permission;
  if (perm !== 'granted') {
    const p = await Notification.requestPermission();
    if (p !== 'granted') { updateNotifButton(); return; }
    notifEnabled = true;
  } else {
    notifEnabled = !notifEnabled;
  }
  localStorage.setItem('notifEnabled', JSON.stringify(notifEnabled));
  updateNotifButton();
};
updateNotifButton();

function maybeNotify({name, text}){
  if (isMe(name)) return;
  if (typeof Notification === 'undefined') return;
  if (!notifEnabled || Notification.permission !== 'granted') return;

  const my = nameSel.value;
  const mentioned = text.includes(`@${my}`);
  const notInFront = document.hidden || !document.hasFocus();

  // 自分宛メンションはフォーカス中でも通知／通常は非表示時のみ
  if (!mentioned && !notInFront) return;

  const title = mentioned ? `📣 あなた宛て (${name})` : `${name}`;
  new Notification(title, { body: text, tag: 'hobby-chat' });
  if (navigator.vibrate) navigator.vibrate(mentioned ? 100 : 30);
}

/* ===== 重複防止 ===== */
const seen = new Set();
const keyOf = (m) => m.id ? `id:${m.id}` : `${m.name}:${m.text}:${m.created_at || ''}`;

/* ===== メンション強調（安全にHTML化） ===== */
function renderTextWithMentions(raw){
  let esc = escapeHTML(raw); // 全文エスケープ
  // 固定4名を <mark> で強調
  esc = esc.replace(/@(?:なおき|りさ|さな|りと)/g, (mt) => `<mark>${mt}</mark>`);
  return esc;
}

/* ===== 描画（最新は下：append） ===== */
function addMsg(m, me=false){
  const k = keyOf(m);
  if (seen.has(k)) return;
  seen.add(k);

  ensureSeparatorForAppend(m.created_at);

  const wrap = document.createElement('div');
  wrap.className = 'bubble' + (me ? ' me' : '');

  const body = document.createElement('div');
  body.className = 'msg-text';
  body.innerHTML = `${escapeHTML(m.name)}: ${renderTextWithMentions(m.text)}`;

  const time = document.createElement('span');
  time.className = 'time';
  time.textContent = relativeTime(m.created_at);

  wrap.append(body, time);
  log.append(wrap);
}

/* ===== システムメッセージ ===== */
function addSys(t){
  const p = document.createElement('div');
  p.className = 'sys';
  p.textContent = t;
  log.append(p);
}

/* ===== 受信（下付近にいる時だけ自動スクロール） ===== */
socket.on('connect', () => { log.replaceChildren(); seen.clear(); lastDateKey = null; });
socket.on('sys', addSys);
socket.on('msg', (m) => {
  const auto = isNearBottom(log);
  const me = isMe(m.name);
  addMsg(m, me);
  if (auto) scrollToBottom(log);
  maybeNotify(m);
});

/* ===== 送信（サーバ戻りのみ描画） ===== */
function joinIfNeeded(){ if (nameSel.value) socket.emit('join', nameSel.value); }
sendB.onclick = () => {
  if (!nameSel.value) return alert('メンバーを選択してください');
  joinIfNeeded();
  const t = textI.value.trim();
  if(!t) return;
  const auto = isNearBottom(log);
  socket.emit('msg', t);
  textI.value = '';
  if (auto) scrollToBottom(log);
};
textI.addEventListener('keydown', e => { 
  if(e.key==='Enter'){
    if (mentionBox.style.display === 'block') {
      e.preventDefault();
      applyActiveMention();
      return;
    }
    sendB.click();
  } else if (e.key === 'Tab' && mentionBox.style.display === 'block') {
    e.preventDefault(); applyActiveMention();
  } else if (e.key === 'ArrowDown' && mentionBox.style.display === 'block') {
    e.preventDefault(); moveActiveMention(1);
  } else if (e.key === 'ArrowUp' && mentionBox.style.display === 'block') {
    e.preventDefault(); moveActiveMention(-1);
  }
});
textI.addEventListener('focus', () => setTimeout(() => textI.scrollIntoView({block:'nearest'}), 50));

/* ===== 履歴削除（管理トークン入力に対応） ===== */
clearB.onclick = () => {
  if (!nameSel.value) return alert('メンバーを選択してください');
  if (!confirm('本当に全履歴を削除しますか？（取り消せません）')) return;
  const token = prompt('管理トークン（任意。設定していない場合は空でOK）');
  socket.emit('clear', { token: token || '' });
};
socket.on('cleared', () => {
  log.replaceChildren();
  seen.clear();
  lastDateKey = null;
  alert('チャット履歴を削除しました');
});

/* ===== メンション補完（@入力で候補表示） ===== */
let activeIdx = -1;

function findMentionToken(){
  // キャレット直前の「@xxxxx」を抽出（行頭/空白から始まる想定）
  const pos = textI.selectionStart;
  const val = textI.value;
  const left = val.slice(0, pos);
  const m = left.match(/(^|\s)@([^\s@]{0,20})$/);
  if(!m) return null;
  const prefix = m[2];               // @ の後ろの入力途中
  const start = pos - prefix.length; // prefix 開始位置
  const atPos = start - 1;           // @ の位置
  return { atPos, start, end: pos, prefix };
}

function showMentionBox(items){
  mentionList.innerHTML = '';
  items.forEach((name, i) => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'mention-item' + (i===0 ? ' active':'');
    b.textContent = '@' + name;
    b.onclick = () => applyMention(name);
    mentionList.appendChild(b);
  });
  activeIdx = items.length ? 0 : -1;
  mentionBox.style.display = items.length ? 'block' : 'none';
}
function hideMentionBox(){
  mentionBox.style.display = 'none';
  activeIdx = -1;
}

function applyMention(name){
  const tok = findMentionToken();
  if(!tok) return hideMentionBox();
  const val = textI.value;
  // @prefix を @name + スペース で置換
  const before = val.slice(0, tok.atPos);
  const after  = val.slice(tok.end);
  textI.value = before + '@' + name + ' ' + after;
  const newPos = (before + '@' + name + ' ').length;
  textI.setSelectionRange(newPos, newPos);
  hideMentionBox();
  textI.focus();
}

function moveActiveMention(step){
  const buttons = [...mentionList.querySelectorAll('.mention-item')];
  if (!buttons.length) return;
  activeIdx = (activeIdx + step + buttons.length) % buttons.length;
  buttons.forEach((b, i) => b.classList.toggle('active', i===activeIdx));
}
function applyActiveMention(){
  const btn = mentionList.querySelector('.mention-item.active');
  if (btn) {
    const name = btn.textContent.replace(/^@/, '');
    applyMention(name);
  }
}

// 入力で候補更新
textI.addEventListener('input', () => {
  const tok = findMentionToken();
  if(!tok){
    hideMentionBox();
    return;
  }
  const cand = MEMBERS.filter(n => n.startsWith(tok.prefix || ''));
  showMentionBox(cand);
});

// 入力欄外クリックで候補を閉じる
document.addEventListener('click', (e) => {
  if (e.target === textI || e.target === mentionBox || mentionBox.contains(e.target)) return;
  hideMentionBox();
});
</script>
</html>